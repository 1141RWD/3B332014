<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <title>JapanGoï½œæ—¥æœ¬æ—…éŠäº’å‹•å¹³å°</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="indexstyle.css">

    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCFBbg5sSHvNKL_Q2tEh3g3sVJtbS6lNmI&callback=initMap&libraries=geometry,places,marker&loading=async" async defer></script>
    <style>
        #map { height: 400px; width: 100%; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        .modal { display: none; align-items: center; justify-content: center; position: fixed; z-index: 3000; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); backdrop-filter: blur(5px); }
    </style>
</head>

<body>

<header>
    <h1>JapanGo æ—¥æœ¬æ—…éŠäº’å‹•å¹³å°</h1>
    <p>æ—…éŠè·¯ç·š Ã— å…¥å¢ƒçŸ¥è­˜ Ã— æ—¥æ–‡å­¸ç¿’ Ã— å°éŠæˆ²</p>
</header>

<div class="admin-menu">
    <div class="main-trigger" id="userTrigger">ğŸ‘¤</div>
    <div class="menu-items">
        <div id="userInfoBox" class="user-profile" style="display:none;">
            <span class="welcome-text">æ­¡è¿å›ä¾†</span>
            <div id="userNameDisplay" class="user-name">è¨ªå®¢</div>
            <hr class="divider">
        </div>
        <button class="route-btn-new" id="mainRouteBtn" onclick="openRoutePlanner()">ğŸ§­ è¦åŠƒè·¯ç·š</button>
        <button class="history-btn-new" onclick="toggleHistoryList()">ğŸ“œ æˆ‘çš„æ­·å²ç´€éŒ„</button>
        <div id="historyContainer" class="history-dropdown-list" style="display:none;">
            <p style="font-size: 12px; color: #999; text-align: center; padding: 10px;">å°šç„¡ç´€éŒ„</p>
        </div>
        <button class="login-btn-new" id="adminLoginBtn" onclick="openLogin()">ğŸ”‘ ç®¡ç†è€…ç™»å…¥</button>
        <button id="logoutNavBtn" class="logout-btn-new" onclick="memberLogout()" style="display:none;">ğŸ”’ ç™»å‡ºæœƒå“¡</button>
    </div>
</div>

<div id="loginBox" class="login-box" style="display:none;">
    <h3>ç®¡ç†è€…ç™»å…¥</h3>
    <input id="adminUser" placeholder="å¸³è™Ÿ"><br>
    <input id="adminPass" type="password" placeholder="å¯†ç¢¼"><br><br>
    <button onclick="login()">ç™»å…¥</button>
    <button onclick="openLogin()" style="background:#ccc; margin-top:5px;">å–æ¶ˆ</button>
</div>

<nav class="navbar">
    <ul>
        <li onclick="goTo('index.html')">é¦–é </li>
        <li onclick="goTo('customs.html')">å…¥å¢ƒæ³¨æ„</li>
        <li onclick="goTo('internal.html')">åœ‹å…§æ³¨æ„</li>
        <li onclick="goTo('Entryquiz.html')">å…¥å¢ƒ Q&A</li>
        <li onclick="goTo('quiz.html')">åœ‹å…§ Q&A</li>
        <li onclick="goTo('japanese.html')">æ—¥æ–‡å­¸ç¿’</li>
    </ul>
</nav>

<div class="container">
    <section class="map-area">
        <div class="section-title">æ—¥æœ¬æ—…éŠåœ°åœ– (Google Maps å®˜æ–¹åœ–è³‡)</div>
        <div id="map"></div>
    </section>
</div>

<section class="event-area">
    <div class="section-title">æ¨è–¦æ´»å‹•</div>
    <div class="filter-bar">
        <input type="text" id="searchInput" placeholder="ğŸ” æœå°‹æ´»å‹•æˆ–åœ°é»" oninput="renderEvents()">
        <select id="regionFilter" onchange="renderEvents()">
            <option value="å…¨éƒ¨">å…¨éƒ¨åœ°å€</option>
            <option value="åŒ—æµ·é“">åŒ—æµ·é“</option>
            <option value="æœ¬å·">æœ¬å·</option>
            <option value="ä¹å·å››åœ‹">ä¹å·ãƒ»å››åœ‹</option>
        </select>
    </div>

    <h2 class="region-title">ğŸ“ åŒ—æµ·é“</h2>
    <div class="event-list" id="hokkaido"></div>
    <h2 class="region-title">ğŸ“ æœ¬å·</h2>
    <div class="event-list" id="honshu"></div>
    <h2 class="region-title">ğŸ“ ä¹å·ãƒ»å››åœ‹</h2>
    <div class="event-list" id="kyushu"></div>
</section>

<div id="sideRoutePanel" class="side-panel">
    <div class="side-panel-header">
        <h2>ğŸ§­ æ—…éŠè¡Œç¨‹è¦åŠƒ</h2>
        <span class="close-side-btn" onclick="closeRoutePlanner()">Ã—</span>
    </div>
    
    <div class="side-panel-content">
        <div class="route-section-first">
            <label class="input-label">ğŸ“ ç¬¬ä¸€æ­¥ï¼šè¨­å®šèµ·é»</label>
            <input type="text" id="startPointInput" placeholder="æœå°‹é£¯åº—æˆ–è»Šç«™..." 
                  style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px;">
        </div>


        <hr style="opacity: 0.3;">

        <div class="route-section-second">
            <label class="input-label" style="margin-top:10px;">ğŸš© ç¬¬äºŒæ­¥ï¼šè¡Œç¨‹æ¸…å–®</label>
            <div id="itineraryList" class="itinerary-list">
                <p id="emptyHint" class="empty-text">é»æ“Šä¸‹æ–¹æ´»å‹•å¡ç‰‡åŠ å…¥æ™¯é»...</p>
            </div>
        </div>
        <hr style="opacity: 0.3;">

        <div class="side-panel-footer">
            <button class="footer-btn clear" onclick="clearItinerary()">æ¸…ç©º</button>
            <button class="footer-btn save" onclick="saveCustomerRecord()">å„²å­˜ç´€éŒ„</button>
            <button class="footer-btn save" onclick="exportItinerary()">åŒ¯å‡ºæ–‡æª”</button>
        </div>
    </div>

    <div class="side-panel-footer">

     </div>
</div>

<div id="memberLoginModal" class="modal" onclick="closeMemberLogin(event)">
    <div class="modal-content auth-card">
        <span class="close-btn" onclick="closeMemberLogin(event)">Ã—</span>
        
        <div id="loginSection">
            <h2 class="auth-title">æœƒå“¡ç™»å…¥</h2>
            <div class="input-group"><input id="memberUser" type="text" required><label>å¸³è™Ÿ</label></div>
            <div class="input-group"><input id="memberPass" type="password" required><label>å¯†ç¢¼</label></div>
            <button class="auth-btn primary" onclick="memberLogin()">ç«‹å³ç™»å…¥</button>
            <p class="auth-footer">é‚„æ²’æœ‰å¸³è™Ÿï¼Ÿ <a href="javascript:void(0)" onclick="toggleAuth('reg')">ç«‹å³è¨»å†Š</a></p>
        </div>

        <div id="registerSection" style="display:none;">
            <h2 class="auth-title">åŠ å…¥æœƒå“¡</h2>
            <div class="input-group"><input id="regUser" type="text" required><label>å¸³è™Ÿ (ID)</label></div>
            <div class="input-group"><input id="regRealName" type="text" required><label>ä½¿ç”¨è€…å§“å</label></div>
            <div class="input-group"><input id="regPhone" type="tel" required><label>é›»è©±è™Ÿç¢¼</label></div>
            <div class="input-group"><input id="regEmail" type="email" required><label>Email</label></div>
            <div class="input-group"><input id="regPass" type="password" required><label>è¨­å®šå¯†ç¢¼</label></div>
            <div class="input-group"><input id="regPassConfirm" type="password" required><label>ç¢ºèªå¯†ç¢¼</label></div>
            <button class="auth-btn secondary" onclick="memberRegister()">å®Œæˆè¨»å†Š</button>
            <p class="auth-footer">å·²æœ‰å¸³è™Ÿï¼Ÿ <a href="javascript:void(0)" onclick="toggleAuth('login')">è¿”å›ç™»å…¥</a></p>
        </div>
    </div>
</div>

<div id="eventModal" class="modal" onclick="closeModal(event)">
    <div class="modal-content">
        <span class="close-btn" onclick="closeModal(event)">Ã—</span>
        <img id="modalImg" style="width:100%; border-radius:10px; margin-bottom:15px;">
        <h2 id="modalTitle"></h2>
        <p id="modalLocation" style="font-weight:bold; color:#1e90ff;"></p>
        <p id="modalDesc" style="line-height:1.6;"></p>
        <p id="modalRoute" style="background:#f0f0f0; padding:12px; border-radius:8px; font-size:14px; margin-top:10px;"></p>
    </div>
</div>

<footer>Â© 2025 JapanGoï½œå‰ç«¯äº’å‹•å°ˆé¡Œ</footer>

<script>
// --- å…¨åŸŸè®Šæ•¸ ---
let map, gMarker = null, gRouteLine = null;
let gRouteMarkers = []; // å­˜å„²åœ°åœ–ä¸Šçš„æ•¸å­—æ¨™è¨˜
let gRoutePoints = [];  // å­˜å„²è¡Œç¨‹æ¸…å–® {pos, name}

// é è¨­æ´»å‹•
const defaultEvents = [
    {region:"åŒ—æµ·é“", title:"æœ­å¹Œé›ªç¥­", location:"æœ­å¹Œ", lat:43.0618, lng:141.3545, desc:"å†¬å­£å¿…çœ‹é›ªé›•æ´»å‹•", route:"æœ­å¹Œç«™ â†’ å¤§é€šå…¬åœ’", img:"imges/æœ­å¹Œé›ªç¥­.jpg"},
    {region:"æœ¬å·", title:"æ±äº¬æ·ºè‰é›·é–€", location:"æ±äº¬", lat:35.7148, lng:139.7967, desc:"æ±äº¬ä¸‹ç”ºæ–‡åŒ–", route:"æ·ºè‰ç«™ â†’ é›·é–€", img:"imges/æ±äº¬æ·ºè‰é›·é–€.jpg"},
    {region:"ä¹å·å››åœ‹", title:"ç¦å²¡å±‹å°", location:"ç¦å²¡", lat:33.5902, lng:130.4017, desc:"å¤œæ™šå±‹å°ç¾é£Ÿ", route:"åšå¤šç«™ â†’ ä¸­æ´²", img:"imges/ç¦å²¡å±‹å°.jpg"}
];
let events = JSON.parse(localStorage.getItem("events")) || defaultEvents;

// --- 1. åˆå§‹åŒ– Google Maps ---
async function initMap() {
    
    // 1. åˆå§‹åŒ–åœ°åœ–
    const center = { lat: 36.2048, lng: 138.2529 };
    map = new google.maps.Map(document.getElementById("map"), {
        zoom: 5,
        center: center,
        mapId: "DEMO_MAP_ID", 
        mapTypeControl: false,
        streetViewControl: true
    });

    // 2. å•Ÿå‹•æœå°‹èµ·é»åŠŸèƒ½ (Autocomplete)
    const input = document.getElementById("startPointInput");
    const autocomplete = new google.maps.places.Autocomplete(input, {
        componentRestrictions: { country: "jp" }, // é™åˆ¶åœ¨æ—¥æœ¬æœå°‹
        fields: ["geometry", "name"]
    });

    // 3. ç›£è½é¸å–äº‹ä»¶ï¼šç•¶ä½¿ç”¨è€…é»é¸ä¸‹æ‹‰é¸å–®ä¸­çš„åœ°é»æ™‚
    autocomplete.addListener("place_changed", () => {
        const place = autocomplete.getPlace();

        if (!place.geometry || !place.geometry.location) {
            alert("è«‹å¾ä¸‹æ‹‰é¸å–®ä¸­é¸æ“‡æ­£ç¢ºçš„åœ°é»ï¼");
            return;
        }

        // å–å¾—åœ°é»çš„åº§æ¨™èˆ‡åç¨±
        const lat = place.geometry.location.lat();
        const lng = place.geometry.location.lng();
        const name = "ğŸ  " + place.name;

        // è§¸ç™¼åŠ å…¥è¡Œç¨‹åŠŸèƒ½ (å®ƒæœƒå¹«ä½ ç•«å‡ºç·¨è™Ÿ 1 æ¨™è¨˜)
        addStopToItinerary(lat, lng, name);

        // é¸å®Œå¾Œæ¸…ç©ºæ–‡å­—ï¼Œæ–¹ä¾¿è¦åŠƒä¸‹ä¸€ç«™
        input.value = "";
    });

    renderEvents();
    updateUI();
}

// --- 2. è¡Œç¨‹è¦åŠƒæ ¸å¿ƒé‚è¼¯ ---
// åŠ å…¥ç«™é»ï¼ˆå¾æœå°‹æˆ–é»æ“Šå¡ç‰‡è§¸ç™¼ï¼‰
async function addStopToItinerary(lat, lng, name) {
    if (localStorage.getItem("memberLogin") !== "true") {
        alert("è«‹å…ˆç™»å…¥æœƒå“¡ï¼");
        return;
    }

    const pos = { lat: Number(lat), lng: Number(lng) };
    
    // å°‡æ–°åœ°é»åŠ å…¥è¡Œç¨‹é™£åˆ—
    gRoutePoints.push({ pos, name });

    // æ›´æ–°å·¦å´æ¸…å–®èˆ‡åœ°åœ–é€£ç·š
    renderItineraryUI(); // é€™æœƒæ›´æ–°å·¦é‚Šçš„ 1. æŸæŸé£¯åº—
    drawGRoute();        // é€™æœƒåœ¨åœ°åœ–ä¸Šç•«å‡ºæ•¸å­—æ¨™è¨˜å’Œè—ç·š
}

// æ¸²æŸ“å³ä¸‹è§’æ¸…å–® UI
function renderItineraryUI() {
    const list = document.getElementById("itineraryList");
    const hint = document.getElementById("emptyHint");
    if (!list) return;

    if (gRoutePoints.length > 0 && hint) hint.style.display = "none";
    
    list.innerHTML = gRoutePoints.map((p, index) => `
        <div style="display:flex; justify-content:space-between; align-items:center; background:#f0f0f0; margin:5px 0; padding:8px; border-radius:5px; font-size:13px; color:#333;">
            <span>${index + 1}. ${p.name}</span>
            <span onclick="removeStop(${index})" style="color:red; cursor:pointer; font-weight:bold; margin-left:10px;">âœ•</span>
        </div>
    `).join('');
}

// åœ¨åœ°åœ–ä¸Šç•«å‡ºå¸¶æœ‰ç·¨è™Ÿçš„æ¨™è¨˜å’Œé€£ç·š
async function drawGRoute() {
    // æ¸…é™¤èˆŠçš„
    if (gRouteLine) gRouteLine.setMap(null);
    gRouteMarkers.forEach(m => m.map = null);
    gRouteMarkers = [];

    const { AdvancedMarkerElement, PinElement } = await google.maps.importLibrary("marker");

    // ç•«å‡ºæ‰€æœ‰é»
    gRoutePoints.forEach((p, index) => {
        const pin = new PinElement({
            glyph: (index + 1).toString(),
            background: "#1e90ff",
            borderColor: "white",
            glyphColor: "white",
        });

        const m = new AdvancedMarkerElement({
            position: p.pos,
            map: map,
            content: pin.element,
            title: p.name
        });
        gRouteMarkers.push(m);
    });

    // ç•«é€£ç·š
    if (gRoutePoints.length >= 2) {
        const path = gRoutePoints.map(p => p.pos);
        gRouteLine = new google.maps.Polyline({
            path: path,
            strokeColor: "#1e90ff",
            strokeOpacity: 0.8,
            strokeWeight: 4,
            map: map
        });
    }
    
    const countEl = document.getElementById("routeCount");
    if (countEl) countEl.innerText = "ç›®å‰ç¯€é»ï¼š" + gRoutePoints.length;
}

// ç§»é™¤å–®ä¸€ç«™é»
function removeStop(index) {
    gRoutePoints.splice(index, 1);
    renderItineraryUI();
    drawGRoute();
}

// æ¸…ç©ºå…¨éƒ¨
function clearRoute() {
    gRoutePoints = [];
    renderItineraryUI();
    drawGRoute();
    if (document.getElementById("emptyHint")) document.getElementById("emptyHint").style.display = "block";
}

// --- 3. åŸæœ‰çš„å¡ç‰‡èˆ‡æœƒå“¡é‚è¼¯ (å·²æ•´åˆæ–°åŠŸèƒ½) ---

async function selectEvent(lat, lng, title, loc, desc, route, img) {
    const pos = { lat: Number(lat), lng: Number(lng) };
    map.setCenter(pos);
    map.setZoom(15);

    if (gMarker) gMarker.map = null;
    const { AdvancedMarkerElement } = await google.maps.importLibrary("marker");
    gMarker = new AdvancedMarkerElement({ map: map, position: pos, title: title });

    document.getElementById("modalImg").src = img;
    document.getElementById("modalTitle").innerText = title;
    document.getElementById("modalLocation").innerText = "ğŸ“ " + loc;
    document.getElementById("modalDesc").innerText = desc;
    
    // åœ¨ Modal åŠ å…¥ä¸€å€‹æŒ‰éˆ•ä¾†ã€ŒåŠ å…¥è¡Œç¨‹ã€
    document.getElementById("modalRoute").innerHTML = `
        <p>ğŸš¶ æ¨è–¦è·¯ç·šï¼š${route}</p>
        <button onclick="addStopToItinerary(${lat}, ${lng}, '${title}')" 
                style="background:#4caf50; color:white; border:none; padding:8px 15px; border-radius:5px; cursor:pointer; width:100%; font-weight:bold; margin-top:10px;">
            â• åŠ å…¥æˆ‘çš„è¡Œç¨‹æ¸…å–®
        </button>
    `;
    document.getElementById("eventModal").style.display = "flex";
}

function toggleAuth(mode) {
    document.getElementById("loginSection").style.display = (mode === 'reg' ? "none" : "block");
    document.getElementById("registerSection").style.display = (mode === 'reg' ? "block" : "none");
}

function memberRegister() {
    const user = document.getElementById("regUser").value.trim();
    const name = document.getElementById("regRealName").value.trim();
    const email = document.getElementById("regEmail").value.trim(); // ğŸ‘ˆ 1. è£œä¸Šé€™è¡Œ
    const pass = document.getElementById("regPass").value.trim();
    const passConfirm = document.getElementById("regPassConfirm").value.trim();

    // 2. æª¢æŸ¥æ¬„ä½æ™‚ä¹Ÿè¦æª¢æŸ¥ email æ˜¯å¦æœ‰å¡«
    if (!user || !name || !email || pass !== passConfirm) { 
        alert("è«‹å¡«å¯«æ‰€æœ‰æ¬„ä½ä¸¦ç¢ºèªå¯†ç¢¼ä¸€è‡´ï¼"); 
        return; 
    }

    let users = JSON.parse(localStorage.getItem("memberUsers")) || [];
    
    // 3. æª¢æŸ¥å¸³è™Ÿæ˜¯å¦é‡è¤‡ (é€²éšå»ºè­°)
    if (users.find(u => u.username === user)) {
        alert("æ­¤å¸³è™Ÿå·²è¢«è¨»å†Šï¼");
        return;
    }

    // 4. å°‡ email å­˜å…¥ç‰©ä»¶ä¸­
    users.push({ 
        username: user, 
        realName: name, 
        email: email, // ğŸ‘ˆ é€™è£¡ä¸€å®šè¦å­˜é€²å»
        password: pass 
    });

    localStorage.setItem("memberUsers", JSON.stringify(users));
    alert("è¨»å†ŠæˆåŠŸï¼è«‹ç™»å…¥ã€‚");
    toggleAuth('login');
}

function memberLogin() {
    const user = document.getElementById("memberUser").value.trim();
    const pass = document.getElementById("memberPass").value.trim();
    const savedUsers = JSON.parse(localStorage.getItem("memberUsers")) || [];
    
    // å°‹æ‰¾åŒ¹é…çš„ç”¨æˆ¶
    const found = savedUsers.find(u => u.username === user && u.password === pass);
    
    if (found) {
        localStorage.setItem("memberLogin", "true");
        localStorage.setItem("currentUserName", found.realName);
        localStorage.setItem("currentUserEmail", found.email); // ğŸ‘ˆ é—œéµï¼šå­˜å…¥ä¿¡ç®±
        location.reload();
    } else { 
        alert("å¸³è™Ÿæˆ–å¯†ç¢¼éŒ¯èª¤ï¼"); 
    }
}

function updateUI() {
   const isLogin = localStorage.getItem("memberLogin") === "true";
    const infoBox = document.getElementById("userInfoBox");
    if (infoBox) infoBox.style.display = isLogin ? "block" : "none";
    
    if (isLogin) {
        document.getElementById("userNameDisplay").innerText = localStorage.getItem("currentUserName");
        // ç™»å…¥å¾Œï¼Œã€Œè¦åŠƒè·¯ç·šã€æŒ‰éˆ•æ‡‰è©²ç¶­æŒé¡¯ç¤ºï¼Œè®“ä½¿ç”¨è€…éš¨æ™‚é»é–‹å·¦å´æ¬„
        document.getElementById("mainRouteBtn").style.display = "block"; 
    }
    
    document.getElementById("userTrigger").style.background = isLogin ? "#4caf50" : "#1e90ff";
    document.getElementById("logoutNavBtn").style.display = isLogin ? "block" : "none";
}

function memberLogout() {
    localStorage.removeItem("memberLogin");
    localStorage.removeItem("currentUserName");
    location.reload();
}

function renderEvents() {
    const keyword = document.getElementById("searchInput").value.toLowerCase();
    const region = document.getElementById("regionFilter").value;
    const lists = { "åŒ—æµ·é“": hokkaido, "æœ¬å·": honshu, "ä¹å·å››åœ‹": kyushu };
    Object.values(lists).forEach(el => el.innerHTML = "");
    events.filter(e => {
        const mText = e.title.toLowerCase().includes(keyword) || e.location.toLowerCase().includes(keyword);
        const mRegion = region === "å…¨éƒ¨" || e.region === region;
        return mText && mRegion;
    }).forEach(e => {
        const card = `
            <div class="event-card" onclick="selectEvent(${e.lat},${e.lng},'${e.title}','${e.location}','${e.desc}','${e.route}','${e.img}')">
                <div class="event-img" style="background-image:url('${e.img || 'images/default.jpg'}')"></div>
                <div class="event-info"><h3>${e.title}</h3><p>ğŸ“ ${e.location}</p></div>
            </div>`;
        if (lists[e.region]) lists[e.region].innerHTML += card;
    });
}

function openLogin() { 
    const b = document.getElementById("loginBox");
    b.style.display = (b.style.display === "none" ? "block" : "none");
}

function login() {
    if(document.getElementById("adminUser").value==="admin" && document.getElementById("adminPass").value==="1234") {
        localStorage.setItem("admin","true");
        window.location.href="admin.html";
    } else { alert("éŒ¯èª¤"); }
}

function closeModal(e) {
    if(e.target.classList.contains("modal") || e.target.classList.contains("close-btn")) {
        document.getElementById("eventModal").style.display="none";
        document.getElementById("memberLoginModal").style.display="none";
    }
}

// --- ä¿®æ”¹é¢æ¿é–‹é—œé‚è¼¯ ---
function openRoutePlanner() {
    // æª¢æŸ¥ç™»å…¥
    if (localStorage.getItem("memberLogin") !== "true") {
        document.getElementById("memberLoginModal").style.display = "flex";
        return;
    }
    // é¡¯ç¤ºå´é‚Šæ¬„
    document.getElementById("sideRoutePanel").classList.add("active");
}

function closeRoutePlanner() {
    document.getElementById("sideRoutePanel").classList.remove("active");
}

/* ================== åŒ¯å‡ºè¡Œç¨‹æ–‡æª”åŠŸèƒ½ ================== */
function exportItinerary() {
    // 1. æŠ“å–è³‡æ–™
    const userName = localStorage.getItem("currentUserName") || "éŠå®¢";
    const userEmail = localStorage.getItem("currentUserEmail") || "æœªæä¾›";

    if (typeof gRoutePoints === 'undefined' || gRoutePoints.length === 0) {
        alert("ç›®å‰è¡Œç¨‹æ¸…å–®æ˜¯ç©ºçš„ï¼Œç„¡æ³•åŒ¯å‡ºå–”ï¼");
        return;
    }

    // 2. æ§‹å»ºæ–‡æª”å…§å®¹ (æ’ç‰ˆç¾åŒ–)
    let content = `ã€ JapanGo æ—…éŠè¡Œç¨‹è¦åŠƒæ–‡æª” ã€‘\r\n`;
    content += `==========================================\r\n`;
    content += `è¦åŠƒè€…ï¼š${userName}\r\n`;
    content += `è¯çµ¡ä¿¡ç®±ï¼š${userEmail}\r\n`;
    content += `åŒ¯å‡ºæ—¥æœŸï¼š${new Date().toLocaleString()}\r\n`;
    content += `==========================================\r\n\r\n`;
    content += `è©³ç´°è¡Œç¨‹é †åºï¼š\r\n`;

    gRoutePoints.forEach((point, index) => {
        const prefix = (index === 0) ? "ğŸ“ [èµ·é»] " : `ğŸš© [ç¬¬ ${index} ç«™] `;
        content += `${prefix}${point.name}\r\n`;
    });

    content += `\r\n==========================================\r\n`;
    content += `æ„Ÿè¬ä½¿ç”¨ JapanGoï¼Œç¥æ‚¨æ—…é€”æ„‰å¿«ï¼`;

    // 3. åŸ·è¡Œä¸‹è¼‰å‹•ä½œ
    const blob = new Blob([content], { type: "text/plain;charset=utf-8" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    
    // è¨­å®šæª”åï¼Œä¾‹å¦‚ï¼šæˆ‘çš„æ—¥æœ¬è¡Œç¨‹_2024.txt
    const dateStr = new Date().toISOString().slice(0, 10);
    a.href = url;
    a.download = `JapanGo_è¡Œç¨‹_${userName}_${dateStr}.txt`;
    
    // è§¸ç™¼é»æ“Šä¸¦ç§»é™¤
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);

    alert("âœ… è¡Œç¨‹æ–‡æª”å·²ç”Ÿæˆä¸¦é–‹å§‹ä¸‹è¼‰ï¼");
}

// æ¸…é™¤æ‰€æœ‰è¡Œç¨‹åŠŸèƒ½
function clearItinerary() {
    // 1. å½ˆå‡ºç¢ºèªè¦–çª—ï¼Œé¿å…ä½¿ç”¨è€…èª¤é»
    if (gRoutePoints.length === 0) {
        alert("ç›®å‰çš„è¡Œç¨‹å·²ç¶“æ˜¯ç©ºçš„å›‰ï¼");
        return;
    }

    if (!confirm("ç¢ºå®šè¦æ¸…ç©ºç›®å‰è¦åŠƒçš„æ‰€æœ‰è¡Œç¨‹å—ï¼Ÿæ­¤å‹•ä½œç„¡æ³•å¾©åŸã€‚")) {
        return;
    }

    // 2. æ¸…ç©ºå­˜å„²åœ°é»çš„é™£åˆ—
    gRoutePoints = [];

    // 3. æ¸…é™¤åœ°åœ–ä¸Šçš„ç·šæ¢èˆ‡æ¨™è¨˜
    // å‡è¨­ä½ çš„ç·šæ¢è®Šæ•¸æ˜¯ gPolyline
    if (typeof gPolyline !== 'undefined' && gPolyline) {
        gPolyline.setMap(null);
        gPolyline = null;
    }

    // 4. æ¸…é™¤åœ°åœ–ä¸Šçš„æ‰€æœ‰æ•¸å­—æ¨™è¨˜ (Markers)
    // å‡è¨­ä½ ç”¨ä¸€å€‹é™£åˆ— gMarkers å­˜å„²æ‰€æœ‰æ¨™è¨˜
    if (typeof gMarkers !== 'undefined' && gMarkers) {
        gMarkers.forEach(marker => marker.setMap(null));
        gMarkers = [];
    }

    // 5. é‡æ–°æ¸²æŸ“å·¦å´ä»‹é¢ (æœƒé¡¯ç¤ºã€Œå°šæœªåŠ å…¥æ™¯é»ã€çš„æç¤º)
    renderItineraryUI();

    // 6. é‡ç½®æœå°‹è¼¸å…¥æ¡†
    const input = document.getElementById("startPointInput");
    if (input) input.value = "";

    alert("è¡Œç¨‹å·²å…¨éƒ¨æ¸…ç©ºï¼");
}

// å„²å­˜ç›®å‰è¡Œç¨‹åˆ°æœ¬åœ°ç´€éŒ„
function saveCustomerRecord() {
    if (gRoutePoints.length === 0) {
        alert("ç›®å‰æ²’æœ‰è¡Œç¨‹è³‡æ–™å¯ä»¥å„²å­˜ï¼");
        return;
    }

    const userName = localStorage.getItem("currentUserName") || "è¨ªå®¢";
    
    // å»ºç«‹ç´€éŒ„ç‰©ä»¶
    const record = {
        user: userName,
        timestamp: new Date().toLocaleString(),
        route: gRoutePoints,
        count: gRoutePoints.length
    };

    // å–å¾—èˆŠç´€éŒ„æˆ–å»ºç«‹æ–°é™£åˆ—
    let history = JSON.parse(localStorage.getItem("itineraryHistory")) || [];
    
    // å°‡æ–°ç´€éŒ„æ¨å…¥æœ€å‰é¢
    history.unshift(record);

    // å„²å­˜å› localStorage
    localStorage.setItem("itineraryHistory", JSON.stringify(history));

    alert(`âœ… å·²æˆåŠŸå„²å­˜ ${userName} çš„è¡Œç¨‹ç´€éŒ„ï¼`);
    renderHistoryList(); // æ›´æ–°é¡¯ç¤ºæ­·å²ç´€éŒ„ (å¦‚æœæœ‰çš„è©±)
}

// åˆ‡æ›æ­·å²ç´€éŒ„æ¸…å–®çš„é¡¯ç¤º/éš±è—
function toggleHistoryList() {
    const container = document.getElementById("historyContainer");
    if (container.style.display === "none") {
        renderHistoryList(); // å±•é–‹æ™‚é †ä¾¿åˆ·æ–°å…§å®¹
        container.style.display = "block";
    } else {
        container.style.display = "none";
    }
}

// ä¿®æ”¹æ¸²æŸ“æ­·å²ç´€éŒ„çš„é‚è¼¯ï¼Œé…åˆæŒ‰éˆ•ä¸‹æ–¹çš„å®¹å™¨
function renderHistoryList() {
    const history = JSON.parse(localStorage.getItem("itineraryHistory")) || [];
    const container = document.getElementById("historyContainer");
    
    if (!container) return;

    if (history.length === 0) {
        container.innerHTML = `<p style="font-size: 12px; color: #999; text-align: center; padding: 10px;">å°šç„¡ç´€éŒ„</p>`;
        return;
    }

    container.innerHTML = history.map((rec, index) => `
        <div class="history-record-item" onclick="loadHistoryRecord(${index})" style="padding: 10px; border-bottom: 1px solid #eee; cursor: pointer;">
            <div style="font-size: 11px; font-weight: bold; color: #333;">ğŸ“… ${rec.timestamp}</div>
            <div style="font-size: 11px; color: #1e90ff;">ğŸ“ å…± ${rec.count} å€‹åœ°é»</div>
        </div>
    `).join('');
}

// ç•¶è¼‰å…¥ç´€éŒ„æ™‚ï¼Œé †ä¾¿æŠŠé¸å–®é—œæ‰ï¼Œè®“ç•«é¢æ¸…çˆ½
function loadHistoryRecord(index) {
    const history = JSON.parse(localStorage.getItem("itineraryHistory")) || [];
    const record = history[index];
    if (!record) return;

    gRoutePoints = record.route;
    renderItineraryUI();
    drawGRoute();

    // é—œé–‰æ¸…å–®å°ç›’å­
    document.getElementById("historyContainer").style.display = "none";
    // æ‰“é–‹å·¦å´è¦åŠƒé¢æ¿
    document.getElementById("sideRoutePanel").classList.add("active");
    
    alert("æ­·å²ç´€éŒ„è¼‰å…¥æˆåŠŸï¼");
}

function goTo(p){ location.href=p; }
function closeMemberLogin(e) { closeModal(e); }
</script>
</body>
</html>