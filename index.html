<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8">
<title>JapanGoï½œæ—¥æœ¬æ—…éŠäº’å‹•å¹³å°</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<link rel="stylesheet" href="indexstyle.css">

<!-- Leaflet -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
</head>

<body>

<header>
  <h1>JapanGo æ—¥æœ¬æ—…éŠäº’å‹•å¹³å°</h1>
  <p>æ—…éŠè·¯ç·š Ã— å…¥å¢ƒçŸ¥è­˜ Ã— æ—¥æ–‡å­¸ç¿’ Ã— å°éŠæˆ²</p>
</header>

<!-- ç™»å…¥æ¡† -->
<div class="admin-menu">
  <div class="main-trigger" id="userTrigger">ğŸ‘¤</div>
  
  <div class="menu-items">
    <div id="userInfoBox" class="user-profile" style="display:none;">
      <span class="welcome-text">æ­¡è¿å›ä¾†</span>
      <div id="userNameDisplay" class="user-name">è¨ªå®¢</div>
      <hr class="divider">
    </div>

    <button class="route-btn-new" id="mainRouteBtn" onclick="openRoutePlanner()">ğŸ§­ è¦åŠƒè·¯ç·š</button>
    <button class="login-btn-new" id="adminLoginBtn" onclick="openLogin()">ğŸ”‘ ç®¡ç†è€…ç™»å…¥</button>
    <button id="logoutNavBtn" class="logout-btn-new" onclick="memberLogout()" style="display:none;">ğŸ”’ ç™»å‡ºæœƒå“¡</button>
  </div>
</div>

<div id="loginBox" class="login-box" style="display:none;">
Â  <h3>ç®¡ç†è€…ç™»å…¥</h3>
Â  <input id="adminUser" placeholder="å¸³è™Ÿ"><br>
Â  <input id="adminPass" type="password" placeholder="å¯†ç¢¼"><br><br>
Â  <button onclick="login()">ç™»å…¥</button>
  <button onclick="openLogin()" style="background:#ccc; margin-top:5px;">å–æ¶ˆ</button>
</div>

<!-- å°è¦½åˆ— -->
<nav class="navbar">
  <ul>
    <!-- ç™»å‡ºæœƒå“¡æŒ‰éˆ• -->
    <li onclick="goTo('index.html')">é¦–é </li>
    <li onclick="goTo('customs.html')">å…¥å¢ƒæ³¨æ„</li>
    <li onclick="goTo('internal.html')">åœ‹å…§æ³¨æ„</li>
    <li onclick="goTo('Entryquiz.html')">å…¥å¢ƒ Q&A</li>
    <li onclick="goTo('quiz.html')">åœ‹å…§ Q&A</li>
    <li onclick="goTo('japanese.html')">æ—¥æ–‡å­¸ç¿’</li>
  </ul>
</nav>

<div class="container">
  <section class="map-area">
    <div class="section-title">æ—¥æœ¬æ—…éŠåœ°åœ–</div>
    <div id="map" style="height:300px;"></div>
  </section>
</div>

<section class="event-area">
  <div class="section-title">æ¨è–¦æ´»å‹•</div>
  <div class="filter-bar">
    <input
      type="text"
      id="searchInput"
      placeholder="ğŸ” æœå°‹æ´»å‹•æˆ–åœ°é»"
      oninput="renderEvents()"
    >

    <select id="regionFilter" onchange="renderEvents()">
      <option value="å…¨éƒ¨">å…¨éƒ¨åœ°å€</option>
      <option value="åŒ—æµ·é“">åŒ—æµ·é“</option>
      <option value="æœ¬æ´²">æœ¬å·</option>
      <option value="ä¹å·å››åœ‹">ä¹å·ãƒ»å››åœ‹</option>
    </select>
  </div>

  <h2 class="region-title">ğŸ“ åŒ—æµ·é“</h2>
  <div class="event-list" id="hokkaido"></div>
  <h2 class="region-title">ğŸ“ æœ¬å·</h2>
  <div class="event-list" id="honshu"></div>
  <h2 class="region-title">ğŸ“ ä¹å·ãƒ»å››åœ‹</h2>
  <div class="event-list" id="kyushu"></div>
</section>

<!-- ===== è·¯ç·šè¦åŠƒ UI ===== -->
<div class="route-ui">
  

  <!-- Panelï¼šè‡ªè¨‚æ—…éŠè·¯ç·š -->
  <div class="route-panel" id="routePanel">
    <h3>ğŸ§­ è‡ªè¨‚æ—…éŠè·¯ç·š</h3>
    <p>é»æ“Šåœ°åœ–åŠ å…¥è·¯ç·šç¯€é»</p>
    <button onclick="clearRoute()">ğŸ—‘ æ¸…é™¤è·¯ç·š</button>
    <span id="routeCount">ç›®å‰ç¯€é»ï¼š0</span>
  </div>

  
</div>

<!-- ===== æœƒå“¡ç™»å…¥ Modal ===== -->
<div id="memberLoginModal" class="modal" onclick="closeMemberLogin(event)">
  <div class="modal-content auth-card">
    <span class="close-btn" onclick="closeMemberLogin(event)">Ã—</span>
    
    <div id="loginSection">
      <h2 class="auth-title">æœƒå“¡ç™»å…¥</h2>
      <div class="input-group">
        <input id="memberUser" type="text" required>
        <label>å¸³è™Ÿ</label>
      </div>
      <div class="input-group">
        <input id="memberPass" type="password" required>
        <label>å¯†ç¢¼</label>
      </div>
      <button class="auth-btn primary" onclick="memberLogin()">ç«‹å³ç™»å…¥</button>
      <p class="auth-footer">é‚„æ²’æœ‰å¸³è™Ÿï¼Ÿ <a href="javascript:void(0)" onclick="toggleAuth('reg')">ç«‹å³è¨»å†Š</a></p>
    </div>

    <div id="registerSection" style="display:none;">
  <h2 class="auth-title">åŠ å…¥æœƒå“¡</h2>
  
  <div class="input-group">
    <input id="regUser" type="text" required>
    <label>å¸³è™Ÿ (ID)</label>
  </div>

  <div class="input-group">
    <input id="regRealName" type="text" required>
    <label>ä½¿ç”¨è€…å§“å</label>
  </div>

  <div class="input-group">
    <input id="regPhone" type="tel" required>
    <label>é›»è©±è™Ÿç¢¼</label>
  </div>

  <div class="input-group">
    <input id="regEmail" type="email" required>
    <label>é›»å­éƒµä»¶ (Email)</label>
  </div>

  <div class="input-group">
    <input id="regPass" type="password" required>
    <label>è¨­å®šå¯†ç¢¼</label>
  </div>

  <div class="input-group">
    <input id="regPassConfirm" type="password" required>
    <label>ç¢ºèªå¯†ç¢¼</label>
  </div>

  <button class="auth-btn secondary" onclick="memberRegister()">å®Œæˆè¨»å†Š</button>
  <p class="auth-footer">å·²æœ‰å¸³è™Ÿï¼Ÿ <a href="javascript:void(0)" onclick="toggleAuth('login')">è¿”å›ç™»å…¥</a></p>
</div>
  </div>
</div>

<!-- ===== æ´»å‹• Modal ===== -->
<div id="eventModal" class="modal" onclick="closeModal(event)">
  <div class="modal-content">
    <span class="close-btn" onclick="closeModal(event)">Ã—</span>
    <img id="modalImg">
    <h2 id="modalTitle"></h2>
    <p id="modalLocation"></p>
    <p id="modalDesc"></p>
    <p id="modalRoute"></p>
  </div>
</div>

<footer>
  Â© 2025 JapanGoï½œå‰ç«¯äº’å‹•å°ˆé¡Œ
</footer>

<script>
// --- ç®¡ç†è€…ç™»å…¥ ---
function openLogin() {
  const box = document.getElementById("loginBox");
  // è®“ç™»å…¥æ¡†åœ¨ é¡¯ç¤º(block) èˆ‡ éš±è—(none) ä¹‹é–“åˆ‡æ›
  if (box.style.display === "none" || box.style.display === "") {
    box.style.display = "block";
  } else {
    box.style.display = "none";
  }
}

function login() {
  const user = document.getElementById("adminUser").value;
  const pass = document.getElementById("adminPass").value;
  if(user === "admin" && pass === "1234"){
    localStorage.setItem("admin","true");
    alert("ç™»å…¥æˆåŠŸï¼Œé€²å…¥ç®¡ç†æ¨¡å¼");
    window.location.href = "admin.html";
  } else {
    alert("å¸³è™Ÿæˆ–å¯†ç¢¼éŒ¯èª¤");
  }
}

// ===== æœƒå“¡ç™»å…¥ / ç™»å‡º / è·¯ç·šè¦åŠƒ =====
function openRoutePlanner() {
  const isLogin = localStorage.getItem("memberLogin") === "true";
  const panel = document.getElementById("routePanel");
  const btn = document.querySelector(".route-btn");
  const logoutBtn = document.getElementById("logoutBtn");

  if (!isLogin) {
    document.getElementById("memberLoginModal").style.display = "flex";
    return;
  }

  if (panel) panel.style.display = "block";
  if (btn) btn.style.display = "none";
  if (logoutBtn) logoutBtn.style.display = "inline-block";
}

// 1. åˆ‡æ›ç™»å…¥èˆ‡è¨»å†Šä»‹é¢
function toggleAuth(mode) {
  const loginSec = document.getElementById("loginSection");
  const regSec = document.getElementById("registerSection");
  if (mode === 'reg') {
    loginSec.style.display = "none";
    regSec.style.display = "block";
  } else {
    loginSec.style.display = "block";
    regSec.style.display = "none";
  }
}

// 2. æœƒå“¡è¨»å†Šé‚è¼¯
function memberRegister() {
  // æŠ“å–æ‰€æœ‰æ¬„ä½æ•¸å€¼
  const user = document.getElementById("regUser").value.trim();
  const name = document.getElementById("regRealName").value.trim();
  const phone = document.getElementById("regPhone").value.trim();
  const email = document.getElementById("regEmail").value.trim();
  const pass = document.getElementById("regPass").value.trim();
  const passConfirm = document.getElementById("regPassConfirm").value.trim();

  // 1. æª¢æŸ¥æ˜¯å¦æ¼å¡«
  if (!user || !name || !phone || !email || !pass || !passConfirm) {
    alert("æ‰€æœ‰æ¬„ä½çš†ç‚ºå¿…å¡«ï¼");
    return;
  }

  // 2. æª¢æŸ¥å¯†ç¢¼èˆ‡ç¢ºèªå¯†ç¢¼æ˜¯å¦ä¸€è‡´
  if (pass !== passConfirm) {
    alert("å…©æ¬¡è¼¸å…¥çš„å¯†ç¢¼ä¸ç›¸åŒï¼Œè«‹é‡æ–°ç¢ºèªï¼");
    return;
  }

  // 3. ç°¡å–®çš„ Email æ ¼å¼é©—è­‰
  if (!email.includes("@")) {
    alert("è«‹è¼¸å…¥æœ‰æ•ˆçš„ Email åœ°å€ï¼");
    return;
  }

  // 4. å–å¾—ç¾æœ‰ä½¿ç”¨è€…æ¸…å–®ä¸¦æª¢æŸ¥å¸³è™Ÿæ˜¯å¦é‡è¤‡
  let users = JSON.parse(localStorage.getItem("memberUsers")) || [];
  if (users.some(u => u.username === user)) {
    alert("æ­¤å¸³è™Ÿå·²è¢«è¨»å†Šï¼Œè«‹æ›ä¸€å€‹å¸³è™Ÿï¼");
    return;
  }

  // 5. å„²å­˜æ–°ä½¿ç”¨è€…ï¼ˆåŒ…å«æ‰€æœ‰è³‡æ–™ï¼‰
  const newUser = {
    username: user,
    realName: name,
    phone: phone,
    email: email,
    password: pass // å¯¦å‹™ä¸Šå»ºè­°åŠ å¯†ï¼Œä½†å°ˆé¡Œç·´ç¿’å¯ç”¨æ˜æ–‡
  };

  users.push(newUser);
  localStorage.setItem("memberUsers", JSON.stringify(users));

  alert("æ­å–œè¨»å†ŠæˆåŠŸï¼å¿«ä¾†è¦åŠƒä½ çš„æ—¥æœ¬ä¹‹æ—…å§ã€‚");
  
  // æ¸…ç©ºè¨»å†Šæ¬„ä½ (é¸ç”¨)
  clearRegisterFields();
  
  // è¿”å›ç™»å…¥ä»‹é¢
  toggleAuth('login');
}

// æ¸…ç©ºè¨»å†Šæ¬„ä½å‡½å¼
function clearRegisterFields() {
  const fields = ["regUser", "regRealName", "regPhone", "regEmail", "regPass", "regPassConfirm"];
  fields.forEach(id => document.getElementById(id).value = "");
}

function memberLogin() {
  const user = document.getElementById("memberUser").value.trim();
  const pass = document.getElementById("memberPass").value.trim();

  // 1. å–å¾—è¨»å†Šæ™‚å­˜å…¥çš„ä½¿ç”¨è€…æ¸…å–®
  const savedUsers = JSON.parse(localStorage.getItem("memberUsers")) || [];

  // 2. é è¨­çš„æ¸¬è©¦å¸³è™Ÿ (ä¿ç•™ä½ åŸæœ¬çš„æ¸¬è©¦å¸³è™Ÿ)
  const isDefaultUser = (user === "user" && pass === "1234");

  // 3. åœ¨è³‡æ–™åº«ä¸­å°‹æ‰¾åŒ¹é…çš„å¸³è™Ÿèˆ‡å¯†ç¢¼
  const foundUser = savedUsers.find(u => u.username === user && u.password === pass);

  if (isDefaultUser || foundUser) {
    // ç™»å…¥æˆåŠŸé‚è¼¯
    localStorage.setItem("memberLogin", "true");
    
    // å¦‚æœæ˜¯å¾è³‡æ–™åº«æ‰¾åˆ°çš„ï¼Œæˆ‘å€‘å¯ä»¥æŠŠä½¿ç”¨è€…çš„å§“åå­˜èµ·ä¾†ï¼Œä¹‹å¾Œé¡¯ç¤ºåœ¨ç•«é¢ä¸Š
    const displayName = foundUser ? foundUser.realName : "æ¸¬è©¦ç”¨æˆ¶";
    localStorage.setItem("currentUserName", displayName);

    alert(`æ­¡è¿å›ä¾†ï¼Œ${displayName}ï¼ç™»å…¥æˆåŠŸã€‚`);
    
    // é—œé–‰å½ˆçª—ä¸¦æ›´æ–°ä»‹é¢
    document.getElementById("memberLoginModal").style.display = "none";
    
    // åŸ·è¡Œä½ åŸæœ¬çš„æ›´æ–°é‚è¼¯
    if (typeof updateUI === "function") updateUI();
    if (typeof openRoutePlanner === "function") openRoutePlanner();
    
  } else {
    // ç™»å…¥å¤±æ•—é‚è¼¯
    alert("å¸³è™Ÿæˆ–å¯†ç¢¼éŒ¯èª¤ï¼Œè«‹å†è©¦ä¸€æ¬¡");
  }
}

function executeLogin() {
  localStorage.setItem("memberLogin", "true");
  alert("ç™»å…¥æˆåŠŸï¼å·²é–‹å•Ÿè·¯ç·šè¦åŠƒåŠŸèƒ½ã€‚");
  document.getElementById("memberLoginModal").style.display = "none";
  updateUI(); // é‡æ–°æ•´ç†æŒ‰éˆ•ç‹€æ…‹
}

function updateRouteUI() {
  const isLogin = localStorage.getItem("memberLogin") === "true";
  const panel = document.getElementById("routePanel");
  const btn = document.querySelector(".route-btn");
  const logoutBtn = document.getElementById("logoutNavBtn"); // ç¢ºä¿ ID æ­£ç¢º

  if (isLogin) {
    if (panel) panel.style.display = "block";
    if (btn) btn.style.display = "none";
    if (logoutBtn) logoutBtn.style.display = "inline-block"; // é¡¯ç¤ºç™»å‡ºæŒ‰éˆ•
  } else {
    if (panel) panel.style.display = "none";
    if (btn) btn.style.display = "block";
    if (logoutBtn) logoutBtn.style.display = "none"; // éš±è—ç™»å‡ºæŒ‰éˆ•
  }
}

function updateUI() {
  const isLogin = localStorage.getItem("memberLogin") === "true";
  const userName = localStorage.getItem("currentUserName");
  
  const infoBox = document.getElementById("userInfoBox");
  const nameDisplay = document.getElementById("userNameDisplay");
  const trigger = document.getElementById("userTrigger");
  const routeBtn = document.getElementById("mainRouteBtn");
  const logoutBtn = document.getElementById("logoutNavBtn");

  if (isLogin) {
    // 1. é¡¯ç¤ºé¸å–®å…§çš„åå­—å€å¡Š
    if (infoBox) infoBox.style.display = "block";
    if (nameDisplay) nameDisplay.innerText = userName || "æœƒå“¡";
    
    // 2. åœ“åœˆæŒ‰éˆ•ä¿æŒåŸæ¨£ï¼Œä½†å¯ä»¥æ›å€‹é¡è‰²ä»£è¡¨å·²ç™»å…¥
    trigger.innerHTML = "ğŸ‘¤"; 
    trigger.style.background = "#4caf50"; // ç™»å…¥è®Šç¶ è‰²
    
    // 3. æ§åˆ¶å…¶å®ƒæŒ‰éˆ•
    if (routeBtn) routeBtn.style.display = "none";
    if (logoutBtn) logoutBtn.style.display = "block";
  } else {
    // æœªç™»å…¥ç‹€æ…‹
    if (infoBox) infoBox.style.display = "none";
    trigger.innerHTML = "ğŸ‘¤";
    trigger.style.background = "#1e90ff"; // æ¢å¾©è—è‰²
    
    if (routeBtn) routeBtn.style.display = "block";
    if (logoutBtn) logoutBtn.style.display = "none";
  }
}

// ç¢ºä¿åœ¨é€™äº›æ™‚æ©Ÿé»éƒ½æœƒæ›´æ–° UI
window.addEventListener('load', updateUI);


window.onload = updateUI;

function memberLogout() {
  localStorage.removeItem("memberLogin");
  alert("å·²ç™»å‡ºæœƒå“¡");

  const panel = document.getElementById("routePanel");
  if(panel) panel.style.display = "none";

  const btn = document.querySelector(".route-btn");
  if(btn) btn.style.display = "block";

  const logoutBtn = document.getElementById("logoutNavBtn");
  if(logoutBtn) logoutBtn.style.display = "none";

  clearRoute();
}

function closeMemberLogin(e) {
  if(e.target.id === "memberLoginModal" || e.target.classList.contains("close-btn")) {
    document.getElementById("memberLoginModal").style.display = "none";
  }
}

// ===== å°è¦½åˆ— =====
function goTo(p){ location.href=p; }

// ===== æ´»å‹•è³‡æ–™ =====
const defaultEvents = [
  {region:"åŒ—æµ·é“", title:"æœ­å¹Œé›ªç¥­", location:"æœ­å¹Œ", lat:43.0618, lng:141.3545, desc:"å†¬å­£å¿…çœ‹é›ªé›•æ´»å‹•", route:"æœ­å¹Œç«™ â†’ å¤§é€šå…¬åœ’", img:"imges/æœ­å¹Œé›ªç¥­.jpg"},
  {region:"åŒ—æµ·é“", title:"å°æ¨½é‹æ²³å¤œæ™¯", location:"å°æ¨½", lat:43.1971, lng:140.9947, desc:"å¾©å¤ç…¤æ°£ç‡ˆé»äº®çš„æµªæ¼«æ¸¯ç”º", route:"æœ­å¹Œç«™ â†’ å°æ¨½ç«™ â†’ é‹æ²³æ•£ç­–", img:"imges/åŒ—æµ·é“å°æ¨½é‹æ²³.jpg"},
  {region:"åŒ—æµ·é“", title:"æ—­å±±å‹•ç‰©åœ’", location:"æ—­å·", lat:43.7687, lng:142.3650, desc:"ä»¥å‹•ç‰©è¡Œå‹•å±•ç¤ºèåçš„è¶…äººæ°£å‹•ç‰©åœ’", route:"æ—­å·ç«™ â†’ æ—­å±±å‹•ç‰©åœ’", img:"imges/æ—­å±±å‹•ç‰©åœ’.jpg"},
  {region:"æœ¬å·", title:"æ±äº¬æ·ºè‰é›·é–€", location:"æ±äº¬", lat:35.7148, lng:139.7967, desc:"æ±äº¬æœ€å…·ä»£è¡¨æ€§çš„ä¸‹ç”ºæ–‡åŒ–", route:"æ·ºè‰ç«™ â†’ é›·é–€ â†’ ä»²è¦‹ä¸–é€š", img:"imges/æ±äº¬æ·ºè‰é›·é–€.jpg"},
  {region:"æœ¬å·", title:"å¯Œå£«å±±æ²³å£æ¹–", location:"å±±æ¢¨", lat:35.5171, lng:138.7516, desc:"æ¬£è³å¯Œå£«å±±å€’å½±çš„æœ€ä½³æ™¯é»", route:"æ–°å®¿ â†’ æ²³å£æ¹–", img:"imges/å¯Œå£«å±±æ²³å£æ¹–.jpg"},
  {region:"æœ¬å·", title:"å¤§é˜ªé“é “å €", location:"å¤§é˜ª", lat:34.6687, lng:135.5011, desc:"ç« é­šç‡’èˆ‡éœ“è™¹ç‡ˆçš„ç¾é£Ÿå¤©å ‚", route:"é›£æ³¢ç«™ â†’ é“é “å €", img:"imges/å¤§é˜ªé“é “å €.jpg"},
  {region:"æœ¬å·", title:"å¥ˆè‰¯æ¢…èŠ±é¹¿å…¬åœ’", location:"å¥ˆè‰¯", lat:34.6851, lng:135.8431, desc:"èˆ‡æ¢…èŠ±é¹¿è¿‘è·é›¢äº’å‹•çš„ä¸–ç•Œéºç”¢å…¬åœ’", route:"è¿‘éµå¥ˆè‰¯ç«™ â†’ å¥ˆè‰¯å…¬åœ’", img:"imges/å¥ˆè‰¯æ¢…èŠ±é¹¿å…¬åœ’.jpg"},
  {region:"æœ¬å·", title:"äº¬éƒ½æ¸…æ°´å¯º", location:"äº¬éƒ½", lat:35.0116, lng:135.7681, desc:"ä¸–ç•Œæ–‡åŒ–éºç”¢", route:"äº¬éƒ½ç«™ â†’ æ¸…æ°´å¯º", img:"imges/äº¬éƒ½æ¸…æ°´å¯º.jpg"},
  {region:"ä¹å·å››åœ‹", title:"ç¦å²¡å±‹å°", location:"ç¦å²¡", lat:33.5902, lng:130.4017, desc:"å¤œæ™šå±‹å°ç¾é£Ÿ", route:"åšå¤šç«™ â†’ ä¸­æ´²", img:"imges/ç¦å²¡å±‹å°.jpg"},
  {region:"ä¹å·å››åœ‹", title:"ç”±å¸ƒé™¢æº«æ³‰", location:"å¤§åˆ†", lat:33.2589, lng:131.3083, desc:"å……æ»¿æ–‡é’é¢¨æ ¼çš„æº«æ³‰å°é®", route:"åšå¤š â†’ ç”±å¸ƒé™¢", img:"imges/ç”±å¸ƒé™¢æº«æ³‰.jpg"},
  {region:"ä¹å·å››åœ‹", title:"é•·å´åŸçˆ†è³‡æ–™é¤¨", location:"é•·å´", lat:32.7733, lng:129.8635, desc:"äº†è§£æ­·å²ã€çæƒœå’Œå¹³çš„é‡è¦æ™¯é»", route:"é•·å´ç«™ â†’ åŸçˆ†è³‡æ–™é¤¨", img:"imges/é•·å´åŸçˆ†è³‡æ–™é¤¨.jpg"},
  {region:"ä¹å·å››åœ‹", title:"é«˜æ¾æ —æ—å…¬åœ’", location:"é¦™å·", lat:34.3389, lng:134.0434, desc:"æ—¥æœ¬ä¸‰å¤§ååœ’ä¹‹ä¸€çš„æ—¥å¼åº­åœ’", route:"é«˜æ¾ç«™ â†’ æ —æ—å…¬åœ’", img:"imges/é«˜æ¾æ —æ—å…¬åœ’.jpg"}
];
let savedData = localStorage.getItem("events");
let events;

if (!savedData) {
  // å¦‚æœå€‰åº«æ²’è³‡æ–™ï¼Œä½¿ç”¨é è¨­è³‡æ–™ä¸¦å­˜å…¥å€‰åº«
  events = defaultEvents;
  localStorage.setItem("events", JSON.stringify(defaultEvents));
} else {
  // å¦‚æœå€‰åº«æœ‰è³‡æ–™ï¼Œè®€å–æœ€æ–°è³‡æ–™
  events = JSON.parse(savedData);
}

// ===== Leaflet åœ°åœ– =====
let map = L.map('map').setView([36.2,138.2],5);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{
  attribution:'Â© OpenStreetMap'
}).addTo(map);

let marker, line;
let routePoints = [];
let userRouteLine = null;
let routeMarkers = [];

map.on("click", function (e) {
  const { lat, lng } = e.latlng;
  routePoints.push([lat,lng]);

  const isLogin = localStorage.getItem("memberLogin") === "true";
  if (!isLogin) {
    alert("è«‹å…ˆç™»å…¥æœƒå“¡ä»¥é–‹å§‹è¦åŠƒè·¯ç·šï¼");
    document.getElementById("memberLoginModal").style.display = "flex";
    return;
  }

  const m = L.circleMarker([lat, lng], {
    radius: 6, color: "#1976d2", fillColor: "#1976d2", fillOpacity: 1
  }).addTo(map);

  routeMarkers.push(m);
  drawUserRoute();
  document.getElementById("routeCount").innerText = "ç›®å‰ç¯€é»ï¼š" + routePoints.length;
});

function drawUserRoute() {
  if(userRouteLine) map.removeLayer(userRouteLine);
  if(routePoints.length >= 2){
    userRouteLine = L.polyline(routePoints, { color:"blue", weight:4 }).addTo(map);
  }
}

function clearRoute() {
  if(userRouteLine) { map.removeLayer(userRouteLine); userRouteLine=null; }
  routeMarkers.forEach(m=>map.removeLayer(m));
  routeMarkers=[];
  routePoints=[];
  document.getElementById("routeCount").innerText="ç›®å‰ç¯€é»ï¼š0";
  alert("è·¯ç·šå·²æ¸…ç©ºï¼Œè«‹é‡æ–°è¦åŠƒ");
}

// ===== æ´»å‹•å¡ç‰‡æ¸²æŸ“ =====
function renderEvents() {
  const keyword = document.getElementById("searchInput").value.toLowerCase();
  const region = document.getElementById("regionFilter").value;

  hokkaido.innerHTML = "";
  honshu.innerHTML = "";
  kyushu.innerHTML = "";

  events.filter(e => {
    const matchText = e.title.toLowerCase().includes(keyword) || e.location.toLowerCase().includes(keyword);
    const matchRegion = region === "å…¨éƒ¨" || e.region === region;
    return matchText && matchRegion;
  }).forEach(e => {
    const card = `
      <div class="event-card"
        onclick="selectEvent(${e.lat},${e.lng},'${e.title}','${e.location}','${e.desc}','${e.route}')">
        <div class="event-img" style="background-image:url('${e.img || 'images/default.jpg'}')"></div>
        <div class="event-info">
          <h3>${e.title}</h3>
          <p>ğŸ“ ${e.location}</p>
          <p>${e.desc}</p>
        </div>
      </div>
    `;
    if(e.region==="åŒ—æµ·é“") hokkaido.innerHTML += card;
    if(e.region==="æœ¬å·") honshu.innerHTML += card;
    if(e.region==="ä¹å·å››åœ‹") kyushu.innerHTML += card;
  });
}

// ===== é»æ“Šæ´»å‹•å¡ç‰‡ =====
function selectEvent(lat, lng, title, loc, desc, route) {
  map.setView([lat,lng],13);
  if(marker) map.removeLayer(marker);
  if(line) map.removeLayer(line);

  marker = L.marker([lat,lng]).addTo(map).bindPopup(`<b>${title}</b><br>${loc}`).openPopup();
  line = L.polyline([[lat-0.03, lng-0.03],[lat,lng]], {color:'red'}).addTo(map);

  document.getElementById("modalImg").src = events.find(e=>e.title===title && e.location===loc).img;
  document.getElementById("modalTitle").innerText = title;
  document.getElementById("modalLocation").innerText = "ğŸ“ " + loc;
  document.getElementById("modalDesc").innerText = desc;
  document.getElementById("modalRoute").innerText = "ğŸš¶ è·¯ç·šï¼š" + route;
  document.getElementById("eventModal").style.display="flex";
}

function closeModal(e) {
  if(e.target.id==="eventModal" || e.target.classList.contains("close-btn")) {
    document.getElementById("eventModal").style.display="none";
  }
}

// åˆæ¬¡æ¸²æŸ“æ´»å‹•å¡ç‰‡
renderEvents();
</script>
</body>
</html>
