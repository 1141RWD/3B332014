<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8">
<title>JapanGoï½œç®¡ç†æ¨¡å¼</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
  :root { --primary: #1976d2; --bg: #f0f4f8; }
  body { font-family:"Noto Sans TC", sans-serif; background: var(--bg); margin:0; color: #333; }
  header { background: var(--primary); color:white; text-align:center; padding:25px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
  
  .admin-box { max-width:900px; margin:30px auto; padding:30px; background:white; border-radius:15px; box-shadow:0 10px 25px rgba(0,0,0,0.05);}
  
  /* è¡¨å–®æ’ç‰ˆå„ªåŒ– */
  .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px; }
  .form-group { display: flex; flex-direction: column; }
  .form-group.full { grid-column: span 2; }
  
  label { font-size: 14px; font-weight: bold; margin-bottom: 5px; color: #666; }
  input, select, textarea { padding:12px; border:1px solid #ddd; border-radius:8px; font-size: 14px; }
  textarea { height: 80px; resize: vertical; }

  button { padding:12px 20px; border:none; border-radius:8px; background: var(--primary); color:white; cursor:pointer; font-weight: bold; transition: 0.3s; }
  button:hover { background:#1565c0; transform: translateY(-2px); }
  button.delete { background: #ff4d4f; }
  button.delete:hover { background: #d9363e; }

  .event-card { padding:20px; margin:15px 0; border-radius:10px; background:#f9fbff; border: 1px solid #e0e6ed; display: flex; justify-content: space-between; align-items: center; }
  .card-info b { font-size: 18px; color: var(--primary); }
  
  .nav-group { position: fixed; top: 20px; right: 20px; display: flex; gap: 10px; }
</style>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
</head>
<body>

<header><h1>ç®¡ç†æ¨¡å¼ï½œæ—¥æœ¬æ´»å‹•æ•¸æ“šä¸­å¿ƒ</h1></header>

<div class="nav-group">
  <button onclick="backHome()">ğŸ  å›é¦–é </button>
  <button onclick="adminLogout()" style="background:#666;">ğŸ”’ ç™»å‡ºç®¡ç†</button>
</div>

<div class="admin-box">
  <h2>âœ¨ æ–°å¢/ç·¨è¼¯æ´»å‹•</h2>
  <div class="form-grid">
    <div class="form-group">
      <label>æ´»å‹•åç¨±</label>
      <input id="newTitle" placeholder="ä¾‹å¦‚ï¼šæœ­å¹Œé›ªç¥­">
    </div>
    <div class="form-group">
      <label>åœ°å€</label>
      <select id="newRegion">
        <option value="åŒ—æµ·é“">åŒ—æµ·é“</option>
        <option value="æœ¬å·">æœ¬å·</option>
        <option value="ä¹å·å››åœ‹">ä¹å·ãƒ»å››åœ‹</option>
      </select>
    </div>
    <div class="form-group">
      <label>å…·é«”åœ°é»</label>
      <input id="newLocation" placeholder="ä¾‹å¦‚ï¼šå¤§é€šå…¬åœ’">
    </div>
    <div class="form-group">
      <label>åœ–ç‰‡è·¯å¾‘</label>
      <input id="newImg" placeholder="ä¾‹å¦‚ï¼šimages/snow.jpg">
    </div>
    <div class="form-group">
      <label>ç·¯åº¦ (Lat)</label>
      <input id="newLat" type="number" step="any" placeholder="43.0618">
    </div>
    <div class="form-group">
      <label>ç¶“åº¦ (Lng)</label>
      <input id="newLng" type="number" step="any" placeholder="141.3545">
    </div>
    <div class="form-group full">
      <label>æ´»å‹•æè¿°</label>
      <textarea id="newDesc" placeholder="è«‹è¼¸å…¥æ´»å‹•è©³ç´°ä»‹ç´¹..."></textarea>
    </div>
    <div class="form-group full">
      <label>å»ºè­°è·¯ç·š</label>
      <input id="newRoute" placeholder="ä¾‹å¦‚ï¼šæœ­å¹Œç«™ â†’ æ­¥è¡Œ 10 åˆ†é˜">
    </div>
  </div>

  <div class="form-group full">
  <label>æœå°‹åœ°å€è½‰æ›åº§æ¨™</label>
  <div style="display: flex; gap: 5px;">
    <input id="addressInput" placeholder="ä¾‹å¦‚ï¼šæ±äº¬éƒ½å°æ±å€æ·ºè‰2-3-1">
    <button type="button" onclick="searchAddress()" style="width: 100px;">è½‰æ›</button>
  </div>
</div>

<div class="form-group">
  <label>ç·¯åº¦ (Lat)</label>
  <input id="newLat" readonly style="background: #eee;" placeholder="è‡ªå‹•å¡«å…¥">
</div>
<div class="form-group">
  <label>ç¶“åº¦ (Lng)</label>
  <input id="newLng" readonly style="background: #eee;" placeholder="è‡ªå‹•å¡«å…¥">
</div>

  <div class="admin-box">
  <h2>ğŸ§­ ç®¡ç†å“¡å¯¦æ¸¬ï¼šè·¯ç·šè¦åŠƒ</h2>
  <div id="map" style="height: 400px; border-radius: 12px; margin-bottom: 15px;"></div>
  
  <div class="route-panel" id="routePanel" style="display: block; position: static; width: 100%; box-shadow: none; border: 1px solid #ddd;">
    <h3>è·¯ç·šç¯€é»</h3>
    <p>é»æ“Šä¸Šæ–¹åœ°åœ–æ¨¡æ“¬è¦åŠƒè·¯ç·š</p>
    <button onclick="clearRoute()" style="background: #f39c12;">ğŸ—‘ æ¸…é™¤è·¯ç·š</button>
    <span id="routeCount">ç›®å‰ç¯€é»ï¼š0</span>
  </div>
</div>

  <button onclick="addEvent()" style="width: 100%; font-size: 16px;">â• åŠ å…¥æ´»å‹•è³‡æ–™åº«</button>

  <h2 style="margin-top: 40px;">ç¾æœ‰æ´»å‹•åˆ—è¡¨</h2>
  <div id="eventList"></div>
</div>

<script>
// --- å®‰å…¨æª¢æŸ¥ ---
if(localStorage.getItem("admin") !== "true"){
  alert("æ¬Šé™ä¸è¶³ï¼Œè«‹é‡æ–°ç™»å…¥");
  window.location.href = "index.html";
}

const defaultEvents = [
  {region:"åŒ—æµ·é“", title:"æœ­å¹Œé›ªç¥­", location:"æœ­å¹Œ", lat:43.0618, lng:141.3545, desc:"å†¬å­£å¿…çœ‹é›ªé›•æ´»å‹•", route:"æœ­å¹Œç«™ â†’ å¤§é€šå…¬åœ’", img:"imges/æœ­å¹Œé›ªç¥­.jpg"},
  {region:"åŒ—æµ·é“", title:"å°æ¨½é‹æ²³å¤œæ™¯", location:"å°æ¨½", lat:43.1971, lng:140.9947, desc:"å¾©å¤ç…¤æ°£ç‡ˆé»äº®çš„æµªæ¼«æ¸¯ç”º", route:"æœ­å¹Œç«™ â†’ å°æ¨½ç«™ â†’ é‹æ²³æ•£ç­–", img:"imges/åŒ—æµ·é“å°æ¨½é‹æ²³.jpg"},
  {region:"åŒ—æµ·é“", title:"æ—­å±±å‹•ç‰©åœ’", location:"æ—­å·", lat:43.7687, lng:142.3650, desc:"ä»¥å‹•ç‰©è¡Œå‹•å±•ç¤ºèåçš„è¶…äººæ°£å‹•ç‰©åœ’", route:"æ—­å·ç«™ â†’ æ—­å±±å‹•ç‰©åœ’", img:"imges/æ—­å±±å‹•ç‰©åœ’.jpg"},
  {region:"æœ¬å·", title:"æ±äº¬æ·ºè‰é›·é–€", location:"æ±äº¬", lat:35.7148, lng:139.7967, desc:"æ±äº¬æœ€å…·ä»£è¡¨æ€§çš„ä¸‹ç”ºæ–‡åŒ–", route:"æ·ºè‰ç«™ â†’ é›·é–€ â†’ ä»²è¦‹ä¸–é€š", img:"imges/æ±äº¬æ·ºè‰é›·é–€.jpg"},
  {region:"æœ¬å·", title:"å¯Œå£«å±±æ²³å£æ¹–", location:"å±±æ¢¨", lat:35.5171, lng:138.7516, desc:"æ¬£è³å¯Œå£«å±±å€’å½±çš„æœ€ä½³æ™¯é»", route:"æ–°å®¿ â†’ æ²³å£æ¹–", img:"imges/å¯Œå£«å±±æ²³å£æ¹–.jpg"},
  {region:"æœ¬å·", title:"å¤§é˜ªé“é “å €", location:"å¤§é˜ª", lat:34.6687, lng:135.5011, desc:"ç« é­šç‡’èˆ‡éœ“è™¹ç‡ˆçš„ç¾é£Ÿå¤©å ‚", route:"é›£æ³¢ç«™ â†’ é“é “å €", img:"imges/å¤§é˜ªé“é “å €.jpg"},
  {region:"æœ¬å·", title:"å¥ˆè‰¯æ¢…èŠ±é¹¿å…¬åœ’", location:"å¥ˆè‰¯", lat:34.6851, lng:135.8431, desc:"èˆ‡æ¢…èŠ±é¹¿è¿‘è·é›¢äº’å‹•çš„ä¸–ç•Œéºç”¢å…¬åœ’", route:"è¿‘éµå¥ˆè‰¯ç«™ â†’ å¥ˆè‰¯å…¬åœ’", img:"imges/å¥ˆè‰¯æ¢…èŠ±é¹¿å…¬åœ’.jpg"},
  {region:"æœ¬å·", title:"äº¬éƒ½æ¸…æ°´å¯º", location:"äº¬éƒ½", lat:35.0116, lng:135.7681, desc:"ä¸–ç•Œæ–‡åŒ–éºç”¢", route:"äº¬éƒ½ç«™ â†’ æ¸…æ°´å¯º", img:"imges/äº¬éƒ½æ¸…æ°´å¯º.jpg"},
  {region:"ä¹å·å››åœ‹", title:"ç¦å²¡å±‹å°", location:"ç¦å²¡", lat:33.5902, lng:130.4017, desc:"å¤œæ™šå±‹å°ç¾é£Ÿ", route:"åšå¤šç«™ â†’ ä¸­æ´²", img:"imges/ç¦å²¡å±‹å°.jpg"},
  {region:"ä¹å·å››åœ‹", title:"ç”±å¸ƒé™¢æº«æ³‰", location:"å¤§åˆ†", lat:33.2589, lng:131.3083, desc:"å……æ»¿æ–‡é’é¢¨æ ¼çš„æº«æ³‰å°é®", route:"åšå¤š â†’ ç”±å¸ƒé™¢", img:"imges/ç”±å¸ƒé™¢æº«æ³‰.jpg"},
  {region:"ä¹å·å››åœ‹", title:"é•·å´åŸçˆ†è³‡æ–™é¤¨", location:"é•·å´", lat:32.7733, lng:129.8635, desc:"äº†è§£æ­·å²ã€çæƒœå’Œå¹³çš„é‡è¦æ™¯é»", route:"é•·å´ç«™ â†’ åŸçˆ†è³‡æ–™é¤¨", img:"imges/é•·å´åŸçˆ†è³‡æ–™é¤¨.jpg"},
  {region:"ä¹å·å››åœ‹", title:"é«˜æ¾æ —æ—å…¬åœ’", location:"é¦™å·", lat:34.3389, lng:134.0434, desc:"æ—¥æœ¬ä¸‰å¤§ååœ’ä¹‹ä¸€çš„æ—¥å¼åº­åœ’", route:"é«˜æ¾ç«™ â†’ æ —æ—å…¬åœ’", img:"imges/é«˜æ¾æ —æ—å…¬åœ’.jpg"}
];

// 1. å…ˆå¾å€‰åº«æ‹¿æ‹¿çœ‹
let savedData = localStorage.getItem("events");
let events;

if (!savedData) {
  // å¦‚æœå€‰åº«æ²’è²¨ï¼Œä½¿ç”¨é è¨­è³‡æ–™ä¸¦å­˜å…¥
  events = [...defaultEvents]; // ä½¿ç”¨å±•é–‹é‹ç®—å­è¤‡è£½ä¸€ä»½
  localStorage.setItem("events", JSON.stringify(events));
} else {
  // å¦‚æœå€‰åº«æœ‰è²¨ï¼Œè®€å–å€‰åº«çš„è²¨
  events = JSON.parse(savedData);
}


let addressMarker = null; // ç”¨ä¾†é¡¯ç¤ºæœå°‹çµæœçš„æ¨™è¨˜

async function searchAddress() {
  const address = document.getElementById("addressInput").value;
  if (!address) {
    alert("è«‹è¼¸å…¥åœ°å€ï¼");
    return;
  }

  // ä½¿ç”¨ OpenStreetMap çš„ Nominatim API
  const url = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(address)}`;

  try {
    const response = await fetch(url);
    const data = await response.json();

    if (data.length > 0) {
      const result = data[0];
      const lat = parseFloat(result.lat);
      const lon = parseFloat(result.lon);

      // 1. è‡ªå‹•å¡«å…¥ç¶“ç·¯åº¦æ¬„ä½
      document.getElementById("newLat").value = lat;
      document.getElementById("newLng").value = lon;

      // 2. åœ°åœ–è·³è½‰ä¸¦æ¨™è¨˜
      map.setView([lat, lon], 16);
      
      if (addressMarker) map.removeLayer(addressMarker);
      addressMarker = L.marker([lat, lon]).addTo(map)
        .bindPopup("æœå°‹çµæœä½ç½®")
        .openPopup();
        
      alert("è½‰æ›æˆåŠŸï¼å·²è‡ªå‹•å¡«å…¥åº§æ¨™ä¸¦å®šä½åœ°åœ–ã€‚");
    } else {
      alert("æ‰¾ä¸åˆ°è©²åœ°å€ï¼Œè«‹å˜—è©¦æ›´ç²¾ç¢ºçš„æè¿°ï¼ˆä¾‹å¦‚åŠ å…¥ï¼šæ—¥æœ¬...ï¼‰ã€‚");
    }
  } catch (error) {
    console.error("Geocoding Error:", error);
    alert("æœå°‹å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯é€£ç·šã€‚");
  }
}

function renderEvents(){
  const list = document.getElementById("eventList");
  list.innerHTML = "";
  
  events.forEach((e, i) => {
    const card = document.createElement("div");
    card.className = "event-card";
    card.innerHTML = `
      <div class="card-info">
        <b>${e.title}</b> <span style="color:#888; font-size:12px;">[${e.region}]</span><br>
        <small>ğŸ“ ${e.location} | ğŸ§­ ${e.lat}, ${e.lng}</small>
      </div>
      <div class="card-btns">
        <button onclick="editEvent(${i})">ğŸ“ ç·¨è¼¯</button>
        <button class="delete" onclick="deleteEvent(${i})">ğŸ—‘ åˆªé™¤</button>
      </div>
    `;
    list.appendChild(card);
  });
  
  // é‡è¦ï¼šæ¯æ¬¡ç•°å‹•éƒ½å­˜å› localStorageï¼Œé¦–é é‡æ–°æ•´ç†å¾Œå°±æœƒçœ‹åˆ°æ–°è³‡æ–™
  localStorage.setItem("events", JSON.stringify(events));
}

function addEvent(){
  const e = {
    title: document.getElementById("newTitle").value,
    location: document.getElementById("newLocation").value,
    lat: parseFloat(document.getElementById("newLat").value),
    lng: parseFloat(document.getElementById("newLng").value),
    desc: document.getElementById("newDesc").value,
    route: document.getElementById("newRoute").value,
    region: document.getElementById("newRegion").value,
    img: document.getElementById("newImg").value || "images/default.jpg" // è£œä¸Šåœ–ç‰‡
  };

  if(!e.title || !e.lat) { alert("è«‹è‡³å°‘å¡«å¯«æ¨™é¡Œèˆ‡ç¶“ç·¯åº¦"); return; }

  events.push(e);
  renderEvents();
  clearForm();
}

function clearForm() {
  const inputs = document.querySelectorAll('.admin-box input, .admin-box textarea');
  inputs.forEach(input => input.value = "");
}

function deleteEvent(i){
  if(confirm("ç¢ºå®šè¦æ°¸ä¹…åˆªé™¤æ­¤æ´»å‹•å—ï¼Ÿ")) {
    events.splice(i, 1);
    renderEvents();
  }
}

function editEvent(i){
  const e = events[i];
  // é€™è£¡ç°¡å–®ç¤ºç¯„ç”¨ promptï¼Œé€²éšåšæ³•å¯ä»¥å¡«å›è¡¨å–®å¾Œæ”¹ç‚ºã€Œå„²å­˜ã€æ¨¡å¼
  const newTitle = prompt("ä¿®æ”¹æ¨™é¡Œ", e.title);
  if(newTitle) {
    e.title = newTitle;
    renderEvents();
  }
}

function backHome(){
  window.location.href = "index.html";
}

function adminLogout() {
  localStorage.removeItem("admin");
  alert("å·²ç™»å‡ºç®¡ç†æ¨¡å¼");
  window.location.href = "index.html";
}

// --- åœ°åœ–åˆå§‹åŒ– ---
let map = L.map('map').setView([36.2, 138.2], 5);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  attribution: 'Â© OpenStreetMap'
}).addTo(map);

let routePoints = [];
let userRouteLine = null;
let routeMarkers = [];

// åœ¨ç®¡ç†é é¢é»æ“Šåœ°åœ–ä¸éœ€è¦æª¢æŸ¥æœƒå“¡ç™»å…¥ï¼Œå› ç‚ºä½ å·²ç¶“æ˜¯ç®¡ç†è€…äº†
map.on("click", async function (e) {
  const { lat, lng } = e.latlng;
  
  // åŸæœ‰çš„è¦åŠƒè·¯ç·šé‚è¼¯...
  
  // æ–°å¢ï¼šåæŸ¥åœ°å€
  const reverseUrl = `https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}`;
  try {
    const res = await fetch(reverseUrl);
    const data = await res.json();
    if (data.display_name) {
       console.log("åµæ¸¬åˆ°åœ°å€ï¼š" + data.display_name);
       // ä½ å¯ä»¥é¸æ“‡æ˜¯å¦è¦æŠŠé€™å€‹åœ°å€å¡«å…¥ addressInput
       document.getElementById("addressInput").value = data.display_name;
       document.getElementById("newLat").value = lat;
       document.getElementById("newLng").value = lng;
    }
  } catch (err) { /* å¿½ç•¥éŒ¯èª¤ */ }
});

function drawUserRoute() {
  if (userRouteLine) map.removeLayer(userRouteLine);
  if (routePoints.length >= 2) {
    userRouteLine = L.polyline(routePoints, { color: "orange", weight: 4 }).addTo(map);
  }
}

function clearRoute() {
  if (userRouteLine) { map.removeLayer(userRouteLine); userRouteLine = null; }
  routeMarkers.forEach(m => map.removeLayer(m));
  routeMarkers = [];
  routePoints = [];
  document.getElementById("routeCount").innerText = "ç›®å‰ç¯€é»ï¼š0";
}

function renderMarkersOnAdminMap() {
  // å…ˆæ¸…é™¤èˆŠæ¨™è¨˜ï¼ˆé€™è£¡å‡è¨­ä½ æœ‰ä¸€å€‹å­˜æ”¾æ´»å‹•æ¨™è¨˜çš„é™£åˆ—ï¼‰
  events.forEach(e => {
    L.marker([e.lat, e.lng])
      .addTo(map)
      .bindPopup(`<b>${e.title}</b><br>${e.location}`);
  });
}

// è¨˜å¾—åœ¨é é¢è®€å–å®Œ events å¾ŒåŸ·è¡Œå®ƒ
renderMarkersOnAdminMap();

// åˆå§‹æ¸²æŸ“
renderEvents();
</script>
</body>
</html>