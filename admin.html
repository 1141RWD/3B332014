<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <title>JapanGo ç®¡ç†ç³»çµ±</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="indexstyle.css">
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCFBbg5sSHvNKL_Q2tEh3g3sVJtbS6lNmI&callback=initAdminMap&libraries=places" async defer></script>
    
    <style>
        body { background: #f4f7f6; padding: 20px; }
        .admin-container { max-width: 1000px; margin: 0 auto; background: white; padding: 30px; border-radius: 15px; box-shadow: 0 5px 20px rgba(0,0,0,0.1); }
        #adminMap { height: 300px; width: 100%; border-radius: 10px; margin-bottom: 20px; border: 2px solid #ddd; }
        .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px; }
        .form-group { display: flex; flex-direction: column; }
        input, select, textarea { padding: 10px; border: 1px solid #ddd; border-radius: 8px; margin-top: 5px; }
        .btn-group { display: flex; gap: 10px; }
        button { padding: 10px 20px; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; transition: 0.3s; }
        .save-btn { background: #1976d2; color: white; }
        .clear-btn { background: #999; color: white; }
        .logout-btn { background: #ff4d4f; color: white; float: right; }
        
        table { width: 100%; border-collapse: collapse; margin-top: 30px; }
        th, td { padding: 12px; border-bottom: 1px solid #eee; text-align: left; }
        th { background: #f8f9fa; color: #1976d2; }
        .delete-link { color: #ff4d4f; cursor: pointer; font-size: 14px; }
        
        .tab-group { border-bottom: 2px solid #eee; margin-bottom: 20px; display: flex; gap: 20px; }
        .tab { padding: 10px 20px; cursor: pointer; border-bottom: 3px solid transparent; }
        .tab.active { border-bottom: 3px solid #1976d2; color: #1976d2; font-weight: bold; }
    </style>
</head>
<body>

<div class="admin-container">
    <button class="logout-btn" onclick="adminLogout()">ç™»å‡ºç®¡ç†ç³»çµ±</button>
    <h1>JapanGo å¾Œå°ç®¡ç†ä¸­å¿ƒ</h1>

    <div class="tab-group">
        <div class="tab active" onclick="switchTab('eventTab')">æ™¯é»æ´»å‹•ç®¡ç†</div>
        <div class="tab" onclick="switchTab('memberTab')">è¨»å†Šæœƒå“¡åå–®</div>
    </div>

    <div id="eventTabContent">
        <div id="adminMap"></div>
        <p style="color: #666; font-size: 14px;">ğŸ’¡ æç¤ºï¼šåœ¨åœ°åœ–ä¸Šé»æ“Šå¯è‡ªå‹•ç²å–ç¶“ç·¯åº¦</p>
        
        <div class="form-grid">
            <div class="form-group"><label>æ´»å‹•åç¨±</label><input type="text" id="evTitle"></div>
            <div class="form-group">
                <label>æ‰€å±¬åœ°å€</label>
                <select id="evRegion">
                    <option value="åŒ—æµ·é“">åŒ—æµ·é“</option>
                    <option value="æœ¬å·">æœ¬å·</option>
                    <option value="ä¹å·å››åœ‹">ä¹å·ãƒ»å››åœ‹</option>
                </select>
            </div>
            <div class="form-group"><label>è©³ç´°åœ°é» (ğŸ“æ–‡å­—)</label><input type="text" id="evLocation"></div>
            <div class="form-group"><label>åœ–ç‰‡è·¯å¾‘ (imges/xxx.jpg)</label><input type="text" id="evImg"></div>
            <div class="form-group"><label>ç·¯åº¦ (Lat)</label><input type="text" id="evLat" readonly></div>
            <div class="form-group"><label>ç¶“åº¦ (Lng)</label><input type="text" id="evLng" readonly></div>
        </div>
        <div class="form-group" style="margin-bottom: 20px;">
            <label>æ´»å‹•æè¿°</label>
            <textarea id="evDesc" rows="3"></textarea>
        </div>

        <div class="btn-group">
            <button class="save-btn" onclick="addEvent()">æ–°å¢æ´»å‹•æ™¯é»</button>
            <button class="clear-btn" onclick="clearForm()">æ¸…ç©ºæ¬„ä½</button>
        </div>

        <table>
            <thead>
                <tr>
                    <th>åœ°å€</th>
                    <th>æ´»å‹•åç¨±</th>
                    <th>åº§æ¨™</th>
                    <th>æ“ä½œ</th>
                </tr>
            </thead>
            <tbody id="eventTableBody"></tbody>
        </table>
    </div>

    <div id="memberTabContent" style="display:none;">
        <h3>ğŸ‘¥ è¨»å†Šæœƒå“¡ç¸½è¦½</h3>
        <table>
            <thead>
                <tr>
                    <th>å¸³è™Ÿ</th>
                    <th>å§“å</th>
                    <th>é›»è©±</th>
                    <th>Email</th>
                    <th>æ“ä½œ</th>
                </tr>
            </thead>
            <tbody id="memberTableBody"></tbody>
        </table>
    </div>
</div>

<script>
// --- å®‰å…¨æª¢æŸ¥ï¼šæœªç™»å…¥ç®¡ç†è€…è·³å›é¦–é  ---
if (localStorage.getItem("admin") !== "true") {
    alert("è«‹å…ˆå¾é¦–é ç™»å…¥ç®¡ç†å“¡å¸³è™Ÿï¼");
    location.href = "index.html";
}

let adminMap;
let adminMarker;

// --- 1. åˆå§‹åŒ–ç®¡ç†å“¡åœ°åœ– ---
function initAdminMap() {
    adminMap = new google.maps.Map(document.getElementById("adminMap"), {
        center: { lat: 36.2048, lng: 138.2529 },
        zoom: 5,
    });

    // é»æ“Šåœ°åœ–è‡ªå‹•å¡«å…¥ç¶“ç·¯åº¦
    adminMap.addListener("click", (e) => {
        const lat = e.latLng.lat().toFixed(6);
        const lng = e.latLng.lng().toFixed(6);
        document.getElementById("evLat").value = lat;
        document.getElementById("evLng").value = lng;

        if (adminMarker) adminMarker.setMap(null);
        adminMarker = new google.maps.Marker({
            position: e.latLng,
            map: adminMap,
            animation: google.maps.Animation.DROP
        });
    });

    renderAdminEvents();
    renderMemberList();
}

// --- 2. åˆ‡æ›æ¨™ç±¤é  ---
function switchTab(tabName) {
    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
    event.target.classList.add('active');
    
    if (tabName === 'eventTab') {
        document.getElementById('eventTabContent').style.display = 'block';
        document.getElementById('memberTabContent').style.display = 'none';
    } else {
        document.getElementById('eventTabContent').style.display = 'none';
        document.getElementById('memberTabContent').style.display = 'block';
    }
}

// --- 3. æ™¯é» CRUD é‚è¼¯ ---
function addEvent() {
    const title = document.getElementById("evTitle").value;
    const region = document.getElementById("evRegion").value;
    const location = document.getElementById("evLocation").value;
    const lat = document.getElementById("evLat").value;
    const lng = document.getElementById("evLng").value;
    const desc = document.getElementById("evDesc").value;
    const img = document.getElementById("evImg").value;

    if (!title || !lat || !lng) { alert("è«‹å¡«å¯«æ´»å‹•åç¨±ä¸¦åœ¨åœ°åœ–ä¸Šé¸å–ä½ç½®ï¼"); return; }

    let events = JSON.parse(localStorage.getItem("events")) || [];
    events.push({ region, title, location, lat: parseFloat(lat), lng: parseFloat(lng), desc, img });
    localStorage.setItem("events", JSON.stringify(events));
    
    alert("æ´»å‹•å·²æˆåŠŸæ–°å¢ï¼");
    clearForm();
    renderAdminEvents();
}

function renderAdminEvents() {
    let events = JSON.parse(localStorage.getItem("events")) || [];
    const tbody = document.getElementById("eventTableBody");
    tbody.innerHTML = events.map((e, index) => `
        <tr>
            <td>${e.region}</td>
            <td>${e.title}</td>
            <td>${e.lat}, ${e.lng}</td>
            <td><span class="delete-link" onclick="deleteEvent(${index})">åˆªé™¤</span></td>
        </tr>
    `).join('');
}

function deleteEvent(index) {
    if (confirm("ç¢ºå®šè¦åˆªé™¤é€™å€‹æ™¯é»å—ï¼Ÿ")) {
        let events = JSON.parse(localStorage.getItem("events")) || [];
        events.splice(index, 1);
        localStorage.setItem("events", JSON.stringify(events));
        renderAdminEvents();
    }
}

// --- 4. æœƒå“¡åå–®é‚è¼¯ ---
function renderMemberList() {
    let users = JSON.parse(localStorage.getItem("memberUsers")) || [];
    const tbody = document.getElementById("memberTableBody");
    tbody.innerHTML = users.map((u, index) => `
        <tr>
            <td>${u.username}</td>
            <td>${u.realName}</td>
            <td>${u.phone}</td>
            <td>${u.email}</td>
            <td><span class="delete-link" onclick="deleteMember(${index})">åœæ¬Š</span></td>
        </tr>
    `).join('');
}

function deleteMember(index) {
    if (confirm("ç¢ºå®šè¦åˆªé™¤è©²æœƒå“¡å—ï¼Ÿé€™å°‡å°è‡´å…¶ç„¡æ³•ç™»å…¥ã€‚")) {
        let users = JSON.parse(localStorage.getItem("memberUsers")) || [];
        users.splice(index, 1);
        localStorage.setItem("memberUsers", JSON.stringify(users));
        renderMemberList();
    }
}

function clearForm() {
    ["evTitle", "evLocation", "evImg", "evLat", "evLng", "evDesc"].forEach(id => document.getElementById(id).value = "");
}

function adminLogout() {
    localStorage.removeItem("admin");
    location.href = "index.html";
}

function goTo(p) { location.href = p; }
</script>
</body>
</html>